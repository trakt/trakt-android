default_platform(:android)

platform :android do
  desc "Distribute Firebase version to me only"
  lane :firebase_distribute_me do
    gradle(
      task: "assembleInternalRelease"
    )

    # Ensure using mike@trakt.tv for this project
    begin
      sh("firebase login:use mike@trakt.tv")
    rescue
      # Already using this account, ignore error
    end

    firebase_app_distribution(
      app: "1:213753735103:android:13d79e31e4663aea06230a",
      testers: "mike@trakt.tv",
      release_notes: ""
    )
  end

  desc "Distribute Firebase version to Internal Testers group"
  lane :firebase_distribute_internal do
    # Ask for optional release notes
    release_notes = UI.input("Enter release notes (optional, press Enter to skip): ") || ""

    gradle(
      task: "assembleInternalRelease"
    )

    # Ensure using mike@trakt.tv for this project
    begin
      sh("firebase login:use mike@trakt.tv")
    rescue
      # Already using this account, ignore error
    end

    firebase_app_distribution(
      app: "1:213753735103:android:13d79e31e4663aea06230a",
      groups: "trakt-internal-testers",
      release_notes: release_notes
    )
  end

  desc "Upload version to PlayStore Internal Track"
    lane :playstore_upload_internal do
      gradle(
        task: "app:bundlePlaystoreRelease"
      )

      supply(
        track: "internal",
        aab: "app/build/outputs/bundle/playstoreRelease/app-playstore-release.aab",
        rollout: "1",
        skip_upload_apk: true,
        skip_upload_metadata: true,
        skip_upload_images: true,
        skip_upload_screenshots: true
      )
  end

  desc "Promote PlayStore Internal Track to Closed Beta Track"
    lane :playstore_promote_internal_to_trakt_beta do
      supply(
        track: "internal",
        track_promote_to: "Trakt Beta",
        rollout: "1",
        skip_upload_apk: true,
        skip_upload_aab: true,
        skip_upload_metadata: true,
        skip_upload_changelogs: true,
        skip_upload_images: true,
        skip_upload_screenshots: true
      )
  end
end
